{"version":3,"file":"index.cjs","sources":["../src/index.js"],"sourcesContent":["import * as sassLib from 'sass'\nimport { normalize, relative, dirname, extname, basename, join } from 'path'\nimport { EOL } from 'os'\n\n/**\n * @typedef {import('sass').Options<'sync'>} Options\n */\n\n/**\n * @param {boolean} isDev\n * @returns {Options}\n * */\nfunction defaults(isDev) {\n  return {\n    style: isDev ? 'expanded' : 'compressed',\n    sourceMap: isDev,\n    sourceMapIncludeSources: isDev,\n    loadPaths: ['node_modules'],\n    entries: {}\n  }\n}\n\n/**\n * Normalize plugin options\n * @param {Options} [options]\n * @returns {Object}\n */\nfunction normalizeOptions(options = {}, isDev) {\n  // make sure entries are not added to defaults on repeat runs\n  const entries = Object.assign({}, options.entries || {})\n  // force async:false, is much slower according to https://sass-lang.com/documentation/js-api/modules#compileAsync\n  // only benefit is being able to use async plugins\n  // local perf tests on bootstrap 5 SCSS have revealed 3x slower build\n  return Object.assign({}, defaults(isDev), options, { async: false, entries })\n}\n\n/**\n * Infer entries from Metalsmith.source() file paths\n *\n * @param {string} parentDir\n * @param {string[]} filepaths\n * @returns {Object.<string,string>}\n */\nfunction inferEntries(parentDir, filepaths) {\n  return filepaths.reduce((result, key) => {\n    const dest = join(parentDir, key)\n    const filename = basename(key, extname(key))\n    result[dest] = join(dirname(key), `${filename}.css`)\n    return result\n  }, {})\n}\n\n/**\n * A Metalsmith plugin to compile SASS/SCSS files\n *\n * @param {Options} options\n * @returns {import('metalsmith').Plugin}\n * @example\n * const isDev = metalsmith.env('NODE_ENV') === 'development'\n *\n * // compile all scss/sass files in metalsmith.source()\n * metalsmith.use(sass()) // defaults\n *\n * metalsmith.use(sass({  // explicit defaults\n *   style:  isDev ? 'expanded' : 'compressed',\n *   sourceMap: isDev,\n *   sourceMapIncludeSources: isDev,\n *   loadPaths: ['node_modules']\n *   entries: {\n *     // add scss entry points from\n *     'lib/outside-source.scss': 'relative/to/dest.css'\n *   }\n * }))\n */\nfunction sass(options) {\n  return function sass(files, metalsmith, done) {\n    options = normalizeOptions(options, metalsmith.env('NODE_ENV') === 'development')\n    const debug = metalsmith.debug('@metalsmith/sass')\n\n    function relPath(path, root) {\n      return relative(root || metalsmith.directory(), metalsmith.path(path))\n    }\n    const srcPath = relPath(metalsmith.source())\n\n    // assume all .scss files under metalsmith.source are sources\n    const implicitEntries = metalsmith\n      .match('**/!(_)*.s{c,a}ss')\n      .filter((entry) => !Object.keys(options.entries).find((key) => relPath(key, metalsmith.source()) === entry))\n\n    if (implicitEntries.length) {\n      Object.assign(options.entries, inferEntries(srcPath, implicitEntries))\n    }\n\n    debug('Running with options %O', options)\n\n    const errors = []\n    Object.entries(options.entries).forEach(([entryKey, dest]) => {\n      const srcRelPath = relPath(entryKey, metalsmith.source())\n      const isInSrcDir = Object.prototype.hasOwnProperty.call(files, srcRelPath)\n      dest = normalize(dest)\n\n      try {\n        let compiled\n\n        if (isInSrcDir) {\n          // if the sass file is inside src, it could contain front-matter or templating\n          // therefore it is unsafe/error-prone to (re-)read it from disk.\n          // SASS doesn't know the file path of the source file (=required for relative imports)\n          // so we need to add it & it should be relative to process.cwd (='.')\n          const compileOptions = Object.assign({}, options, {\n            loadPaths: [].concat(options.loadPaths, [dirname(relPath(entryKey, '.'))])\n          })\n          compiled = sassLib.compileString(files[srcRelPath].contents.toString(), compileOptions)\n        } else {\n          compiled = sassLib.compile(metalsmith.path(entryKey), options)\n        }\n\n        let css = compiled.css\n\n        if (options.sourceMap) {\n          const sourceMapPath = `${dest}.map`\n          // relative source map paths are the safest as the build folder could be served from a subpath\n          const sourceMapRelPath = relPath(sourceMapPath, dirname(dest))\n          files[sourceMapPath] = {\n            contents: Buffer.from(JSON.stringify(compiled.sourceMap))\n          }\n          css += `${EOL}/*# sourceMappingURL=${sourceMapRelPath} */`\n        }\n\n        // if the sass entry is inside Metalsmith.source...\n        if (isInSrcDir) {\n          // ...reuse its file metadata\n          files[dest] = files[srcRelPath]\n          // ...then delete the source\n          delete files[srcRelPath]\n        } else {\n          files[dest] = {}\n        }\n\n        // finally (over)write its contents\n        files[dest].contents = Buffer.from(css)\n\n        debug('Finished compiling %s to %s', entryKey, dest)\n      } catch (err) {\n        // we don't call done(err) so we can log multiple sass errors at once for multiple entrypoints\n        // this is more convenient than having to re-run the build on each subsequent error\n        errors.push(err)\n      }\n    })\n\n    // cleanup sass partials\n    const sassPartials = metalsmith.match('**/_*.s{c,a}ss', Object.keys(files))\n    if (sassPartials.length) {\n      sassPartials.forEach((path) => {\n        delete files[path]\n      })\n      // sass partials are read into memory by the SASS lib,\n      // keeping them inside metalsmith.source() creates read overhead\n      debug.warn(\n        'Removed %s partials from the build. For better performance, move your SASS partials out of \"%s\"',\n        sassPartials.length,\n        metalsmith.source()\n      )\n    }\n\n    errors.forEach((err) => debug.error('Sass compilation error: %s', err.message))\n    done(errors[0])\n  }\n}\n\nexport default sass\n"],"names":["defaults","isDev","style","sourceMap","sourceMapIncludeSources","loadPaths","entries","normalizeOptions","options","Object","assign","async","inferEntries","parentDir","filepaths","reduce","result","key","dest","join","filename","basename","extname","dirname","sass","files","metalsmith","done","env","debug","relPath","path","root","relative","directory","srcPath","source","implicitEntries","match","filter","entry","keys","find","length","errors","forEach","entryKey","srcRelPath","isInSrcDir","prototype","hasOwnProperty","call","normalize","compiled","compileOptions","concat","sassLib","compileString","contents","toString","compile","css","sourceMapPath","sourceMapRelPath","Buffer","from","JSON","stringify","EOL","err","push","sassPartials","warn","error","message"],"mappings":"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"}